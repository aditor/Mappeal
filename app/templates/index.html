<!DOCTYPE html>
<html>
<script src="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js">
    </script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <head>

    <style>
       /* Set the size of the div element that contains the map */
      #map {
        height: 1000px;  /* The height is 400 pixels */
        width: 100%;  /* The width is the width of the web page */
       }

       #streetview {
        display: none;
      }
    </style>
  </head>
  <body>
  	        <h1>Hello, FINALLY!</h1>

    <h3>My Google Maps Demo</h3>


	  Enter city: <input id="cityInput"type="text" name="city"><br>
	  <button id="mapBtn">Submit</button>


    <!--The div element for the map -->
    <img id="streetview" />
    <div id="map"></div>
    <script>

// Initialize and add the map

// first search in box, go to place on map
// THEN click on map to show dots only in certain neighborhoods
// LAter, add a radius choice, so they can choose larger/smaller circles
function plotMap(res, map){
    var circle = {
        path: google.maps.SymbolPath.CIRCLE,
        fillColor: 'red',
        fillOpacity: .4,
        strokeColor: 'white',
        strokeWeight: .5,
        scale: 3
    };
    var infowindow =  new google.maps.InfoWindow({});
    var marker;
    var count;
    var markercollect = [];
    var listOfURLS = [];
    //console.log(res)
    //var locations = JSON.parse(res)['payload'];
    
    	for (count = 0; count < res.length; count++) {

          //https://maps.googleapis.com/maps/api/geocode/json?latlng=40.714224,-73.961452&key=AIzaSyAeFC4kvVAYZHn0xPeQzcFMg7F_wFO7wA4
          $.get('https://maps.googleapis.com/maps/api/geocode/json', {
              key: "AIzaSyAeFC4kvVAYZHn0xPeQzcFMg7F_wFO7wA4",
              latlng: res[count][0] + ","+ res[count][1]
            }, function(data) {

                for (count2 = 0; count2 < data.results.length; count2++) {
                  //console.log(data.results[count2]);

                  marker = new google.maps.Marker({
                    position: new google.maps.LatLng(data.results[count2].geometry.location.lat, data.results[count2].geometry.location.lng),
                     map: map,
                    icon: circle
                  });

                  var streetViewURL = "https://maps.googleapis.com/maps/api/streetview?location=" + data.results[count2].geometry.location.lat + ","+ data.results[count2].geometry.location.lng + "&";

                  var fullStreetURL = streetViewURL + $.param({
                                    heading: "151.78",
                                    size:"600x400",
                                    pitch: "-0.76"
                                  })
                  console.log("HERE" + fullStreetURL)
                  listOfURLS.push(fullStreetURL)

                  marker.addListener('mouseover', function() {
                    $('#streetview')
                      .attr('src', fullStreetURL).show();
                  });
                  break;
                }
            });
    	}
      // console.log(JSON.stringify({"here":listOfURLS}))
      // var packaged = {"allPoints" : listOfURLS}
      // $.ajax({
      //       url: '/analyze',
      //       type: 'POST',
      //       //send the latlon below
      //       data: JSON.stringify({"pleasework": packaged}),
      //       contentType:'application/json',
      //       success: function(result){

      //       }
      //   }).fail(function(data){
      //       console.error("ERROR - Failed:" + data);
      //   });

}

function initMap() {

var that = this;

var map = new google.maps.Map(document.getElementById('map'), {
    zoom: 9,
    center: {lat: 45.5, lng: -73}
  });

this.map = map;

   $('#mapBtn').on('click', function () {
        var cityToSearch = $('#cityInput').val();
        $.ajax({
            url: '/api/search',
            type: 'POST',
            //send the latlon below
            data: JSON.stringify({"city":cityToSearch}),
            contentType:'application/json',
            success: function(result){
              console.log(result);
             //plotMap(JSON.parse(result), that.map);
            }
        }).fail(function(data){
            console.error("ERROR - Failed:" + data);
        });
    });

	   // // Add a marker clusterer to manage the markers.
    //     var markerCluster = new MarkerClusterer(map, markercollect,
    //         {imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});

}
    </script>
    <!--Load the API from the specified URL
    * The async attribute allows the browser to render the page while the API loads
    * The key parameter will contain your own API key (which is not needed for this tutorial)
    * The callback parameter executes the initMap() function
    -->
    <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAeFC4kvVAYZHn0xPeQzcFMg7F_wFO7wA4&callback=initMap" async defer>
     </script>
  </body>
</html>

<!--                   // $.get(streetViewURL,  {
                  //     key: "AIzaSyAeFC4kvVAYZHn0xPeQzcFMg7F_wFO7wA4"
                  //   }, function(image) {
                          // var append_img = $(image);
                          // var img_base64 = $(image).attr('src');
                          // var image = new Image();
                          // image.src = img_base64;
                          // var canvas = document.getElementById('canvas').getContext('2d');
                          // canvas.drawImage(image, 0, 0);

                          // if(image != null){

                              // var infowindow = new google.maps.InfoWindow({
                              //   content: image
                              // });

                                                        // }
                            //   google.maps.event.addListener(marker, 'click', (function (marker, count) {
                            //   return function () {
                            //     infowindow.setContent(image);
                            //     infowindow.open(map, marker);
                            //   }
                            // })(marker, count));
                    //       }
                         
                          

                    // })
                   

                  // google.maps.event.addListener(marker, 'click', (function (marker, count) {
                  //   return function () {
                  //     //infowindow.setContent(res[count]["name"]);
                  //     infowindow.open(map, marker);
                  //   }
                  // })(marker, count));
 -->